---
// Import the global.css file here so that it is included on
// all pages through the use of the <BaseHead /> component.
import "../styles/global.css";

export interface Props {
	title: string;
	description: string;
	image?: string;
	ogType?: string;
}

const { title, description, image = "/social_img.webp", ogType = "website" } = Astro.props;
---

<!-- Global Metadata -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<meta name="generator" content={Astro.generator} />

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />

<!-- Sitemap -->
<link rel="sitemap" href="/sitemap-index.xml" />

<!-- Google tag (gtag.js) -->
<script is:inline src="https://www.googletagmanager.com/gtag/js?id=G-1DEE29SPLT"></script>
<script is:inline>
	window.dataLayer = window.dataLayer || [];
	function gtag() {
		dataLayer.push(arguments);
	}
	gtag("js", new Date());

	gtag("consent", "default", {
		ad_storage: "denied",
		ad_user_data: "denied",
		ad_personalization: "denied",
		analytics_storage: "denied",
	});

	gtag("config", "G-1DEE29SPLT");
</script>

<!-- MathJax -->
<script is:inline>
	// MathJax configuration: enable automatic numbering of all display equations and inline math
	window.MathJax = {
		tex: {
			tags: "ams",
			tagSide: "right",
			tagIndent: "0em",
			inlineMath: [
				["\\(", "\\)"],
				["$", "$"],
			],
			displayMath: [
				["\\[", "\\]"],
				["$$", "$$"],
			],
			processEscapes: true,
			processEnvironments: true,
			packages: { "[+]": ["ams"] },
		},
		// Defer automatic typesetting; we'll trigger it (and re-trigger after transitions)
		startup: { typeset: false },
	};
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js"></script>

<!-- Re-typeset MathJax after Astro view transitions / page loads -->
<script is:inline>
	function typesetMath() {
		if (!window.MathJax) return;
		const container = document.querySelector("article") || document.querySelector("main") || document.body;
		// Reset equation numbering so it starts fresh per page
		try {
			if (window.MathJax.texReset) {
				window.MathJax.texReset();
			}
			// Deep reset of tag counters (MathJax v3/v4 internal API - guarded)
			const startup = window.MathJax.startup;
			if (startup && startup.document && startup.document.inputJax && startup.document.inputJax[0]) {
				const tags = startup.document.inputJax[0].parseOptions?.tags;
				if (tags) {
					tags.counter = 0;
					if (typeof tags.all === "object") {
						for (const k of Object.keys(tags.all)) delete tags.all[k];
					}
				}
			}
		} catch (_) {
			/* non-fatal */
		}
		// v3/v4 style
		if (window.MathJax.typesetPromise) {
			// Clear prior state for partial re-render if available
			if (window.MathJax.typesetClear) {
				try {
					window.MathJax.typesetClear([container]);
				} catch (_) {
					/* noop */
				}
			}
			window.MathJax.typesetPromise([container]).catch((err) => console.error("MathJax typeset error", err));
		} else if (window.MathJax.Hub && window.MathJax.Hub.Queue) {
			// v2 fallback
			window.MathJax.Hub.Queue(["Typeset", window.MathJax.Hub, container]);
		}
	}

	// Initial load (after script ready)
	document.addEventListener("DOMContentLoaded", () => {
		if (window.MathJax && window.MathJax.startup && window.MathJax.startup.promise) {
			window.MathJax.startup.promise.then(typesetMath);
		} else {
			// Fallback retry loop if MathJax script still loading
			let tries = 0;
			const interval = setInterval(() => {
				tries++;
				if (
					window.MathJax &&
					(window.MathJax.typesetPromise || (window.MathJax.Hub && window.MathJax.Hub.Queue))
				) {
					clearInterval(interval);
					typesetMath();
				} else if (tries > 20) {
					clearInterval(interval);
				}
			}, 150);
		}
	});

	// Astro view transition events
	document.addEventListener("astro:after-swap", typesetMath);
	document.addEventListener("astro:page-load", typesetMath);
</script>
